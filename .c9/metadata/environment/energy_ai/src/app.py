{"filter":false,"title":"app.py","tooltip":"/energy_ai/src/app.py","undoManager":{"mark":68,"position":68,"stack":[[{"start":{"row":0,"column":0},"end":{"row":181,"column":0},"action":"insert","lines":["import boto3","import json","import csv","import io","import json","import os","  ","# Environment variables setting","region = os.environ['REGION_NAME']","bedrock_model_id = os.environ['BEDROCK_MODEL']","# email = os.environ['EMAIL_ADDRESS']","table_name = os.environ['NOTI_TABLE']","partition_key = os.environ['PARTITION_KEY']","","","","# Initialize S3 & SNS & DynamoDB client","s3 = boto3.client('s3', region)","sns_client = boto3.client('sns')","dynamodb = boto3.resource('dynamodb') ","","","def save_to_dynamodb(message_id, subject, message):","    ","    table = dynamodb.Table(table_name)","    ","    # Define the item to be inserted","    item = {","        partition_key: message_id,","        'Subject': subject,","        'Message': message,","        # 'RecordTime': datetime.now()","    }","    ","    # Insert the item into DynamoDB","    table.put_item(Item=item)","    ","    print(f'Jobs {message_id} created successfully')","","def detect_anomaly():","    bucket_name = os.environ['SCORE_DATA'] # 'aws-toys-rong'","    file_key = 'anomaly_scores.csv'","","    response = s3.get_object(Bucket=bucket_name, Key=file_key)","    csv_content = response['Body'].read().decode('utf-8')","","    # Parse CSV content","    csv_rows = csv.DictReader(io.StringIO(csv_content))","","    # Initialize Bedrock client","    bedrock = boto3.client(service_name='bedrock-runtime', region_name='us-west-2')","","    for row in csv_rows:","        score = float(row['anomaly_score'])","        if score > 1:","            date = row['Date']","            Target = row['Target']","            value = row['Value (kWh)']","            prompt = f\"As an energy management expert with over 30 years of experience, we're reaching out to you for assistance in analyzing anomalous data related to building energy consumption. Your insights are invaluable in resolving this issue.\\n\\n\" \\","         f\"Item: {Target}\\n\" \\","         f\"Date: {date}\\n\" \\","         f\"Energy Consumption Value: {value} kWh\\n\" \\","         f\"Anomaly Score: {score}\\n\\n\" \\","                 f\"Please provide the following:\\n\\n\" \\","         f\"1. Brief summary of the anomaly, including how the energy consumption value deviates from normal patterns.\\n\\n\" \\","         f\"2. Analysis of possible causes for the anomaly.\\n\" \\","         f\"3. Steps for further investigation.\\n\" \\","         f\"4. Recommended methods to address and resolve the issue.\\n\\n\" \\","         f\"Your suggestions should be detailed and specific to effectively address the anomaly.\"","         ","        # Set Bedrock model input parameters","        input_data = {","            \"modelId\": \"cohere.command-text-v14\",","            \"contentType\": \"application/json\",","            \"accept\": \"*/*\",","            \"body\": {","                \"prompt\": prompt,","                \"max_tokens\": 1000,","                \"temperature\": 0.75,","                \"p\": 0.01,","                \"k\": 0,","                \"stop_sequences\": [],","                \"return_likelihoods\": \"NONE\"","            }","        }","        # Call Bedrock model","        response = bedrock.invoke_model(","            body=json.dumps(input_data[\"body\"]),","            modelId=input_data[\"modelId\"],","            accept=input_data[\"accept\"],","            contentType=input_data[\"contentType\"]","        )","    ","        # Parse Bedrock response","        response_body = json.loads(response['body'].read())","        explanation = response_body['generations'][0]['text']    ","        print(explanation)","        ","        return explanation ","    ","    ","def lambda_handler(event, context):","    ","    explanation = detect_anomaly()","","    # # 設定存儲桶名稱和檔案名稱","    # # Extract information from the event","    # for record in event['Records']:","    #     bucket_name = record['s3']['bucket']['name']","    #     object_key = record['s3']['object']['key']","    #     event_name = record['eventName']","        ","    #     # bucket_name = 'rong-test-0512'","    #     # file_key = 'energy.csv'","    ","    #     # 讀取 CSV 檔案","    #     response = s3.get_object(Bucket=bucket_name, Key=object_key)","    #     csv_content = response['Body'].read().decode('utf-8')","        ","    #     # 將 CSV 轉換為 JSON 格式","    #     csv_rows = csv.DictReader(io.StringIO(csv_content))","    #     json_output = json.dumps([row for row in csv_rows])","    #     print(json_output)","    ","","","    #     # 根據 CSV 檔案的內容動態生成提示訊息","    #     prompt = f'explain the text {json_output}'","    #     # prompt = f'explain the text {json_output2}'","            ","    #     # 建立 Bedrock 客戶端","    #     bedrock = boto3.client(","    #         service_name='bedrock-runtime'#,","    #         # region_name='us-west-2'","    #     )  ","    ","        ","    #     # 設置 Bedrock 模型的輸入參數","    #     input_data = {","    #         \"modelId\": bedrock_model_id,  # \"cohere.command-text-v14\",","    #         \"contentType\": \"application/json\",","    #         \"accept\": \"*/*\",","    #         \"body\": {","    #             \"prompt\": prompt,","    #             \"max_tokens\": 1000,","    #             \"temperature\": 0.75,","    #             \"p\": 0.01,","    #             \"k\": 0,","    #             \"stop_sequences\": [],","    #             \"return_likelihoods\": \"NONE\"","    #         }","    #     }","        ","    #     # 呼叫 Bedrock 模型","    #     response = bedrock.invoke_model(","    #         body=json.dumps(input_data[\"body\"]),","    #         modelId=input_data[\"modelId\"],","    #         accept=input_data[\"accept\"],","    #         contentType=input_data[\"contentType\"]","    #     )","    ","    #     # 讀取上面的s3內檔案並解析回應","    #     response_body = json.loads(response['body'].read())","    #     explanation = response_body['generations'][0]['text']","    #     # print(explanation)","","    sns_topic_arn = os.environ['SNS_ARN']","    message_text = f\"Dear Facility Manager, \\n {explanation} \\n Regards,\\n Your AI Assistant\"","    subject_text = \"Facility update: Action required for anomalous data\"","    try:","        sent_message = sns_client.publish(TopicArn=sns_topic_arn, Message=message_text, Subject=subject_text)","        if sent_message['ResponseMetadata']['HTTPStatusCode'] == 200:","            print(sent_message)","            print(\"Notification send successfully..!!!\")","            #return True","            message_id = sent_message['MessageId']","            save_to_dynamodb(message_id, subject_text, message_text)","            print(\"Notification stored successfully..!!!\")","    except Exception as e:","        print(\"Error occured while publish notifications and error is : \", e)","        return True",""],"id":1}],[{"start":{"row":14,"column":0},"end":{"row":21,"column":33},"action":"insert","lines":["dynamodb = boto3.resource('dynamodb')","table = dynamodb.Table('CsvData')  # Replace 'CsvData' with your DynamoDB table name","","def lambda_handler(event, context):","    try:","        # Query DynamoDB table for all items","        response = table.scan()","        items = response['Items']"],"id":2}],[{"start":{"row":21,"column":33},"end":{"row":22,"column":0},"action":"insert","lines":["",""],"id":3},{"start":{"row":22,"column":0},"end":{"row":22,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":17,"column":0},"end":{"row":18,"column":8},"action":"remove","lines":["def lambda_handler(event, context):","    try:"],"id":4}],[{"start":{"row":14,"column":0},"end":{"row":14,"column":37},"action":"remove","lines":["dynamodb = boto3.resource('dynamodb')"],"id":5}],[{"start":{"row":15,"column":0},"end":{"row":15,"column":1},"action":"insert","lines":["r"],"id":6},{"start":{"row":15,"column":1},"end":{"row":15,"column":2},"action":"insert","lines":["c"]},{"start":{"row":15,"column":2},"end":{"row":15,"column":3},"action":"insert","lines":["f"]}],[{"start":{"row":15,"column":3},"end":{"row":15,"column":4},"action":"insert","lines":["_"],"id":7},{"start":{"row":15,"column":4},"end":{"row":15,"column":5},"action":"insert","lines":["s"]},{"start":{"row":15,"column":5},"end":{"row":15,"column":6},"action":"insert","lines":["c"]},{"start":{"row":15,"column":6},"end":{"row":15,"column":7},"action":"insert","lines":["o"]},{"start":{"row":15,"column":7},"end":{"row":15,"column":8},"action":"insert","lines":["r"]},{"start":{"row":15,"column":8},"end":{"row":15,"column":9},"action":"insert","lines":["e"]},{"start":{"row":15,"column":9},"end":{"row":15,"column":10},"action":"insert","lines":["_"]}],[{"start":{"row":15,"column":17},"end":{"row":15,"column":18},"action":"insert","lines":[" "],"id":8}],[{"start":{"row":15,"column":18},"end":{"row":15,"column":42},"action":"insert","lines":["os.environ['NOTI_TABLE']"],"id":9}],[{"start":{"row":15,"column":42},"end":{"row":15,"column":43},"action":"insert","lines":[" "],"id":10},{"start":{"row":15,"column":43},"end":{"row":15,"column":44},"action":"insert","lines":["#"]}],[{"start":{"row":15,"column":44},"end":{"row":15,"column":45},"action":"insert","lines":[" "],"id":11}],[{"start":{"row":15,"column":30},"end":{"row":15,"column":40},"action":"remove","lines":["NOTI_TABLE"],"id":12},{"start":{"row":15,"column":30},"end":{"row":15,"column":40},"action":"insert","lines":["SCORE_DATA"]}],[{"start":{"row":19,"column":19},"end":{"row":19,"column":24},"action":"remove","lines":["table"],"id":13},{"start":{"row":19,"column":19},"end":{"row":19,"column":34},"action":"insert","lines":["rcf_score_table"]}],[{"start":{"row":13,"column":0},"end":{"row":14,"column":0},"action":"remove","lines":["",""],"id":14},{"start":{"row":12,"column":43},"end":{"row":13,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":16,"column":0},"end":{"row":18,"column":33},"action":"remove","lines":["        # Query DynamoDB table for all items","        response = rcf_score_table.scan()","        items = response['Items']"],"id":15}],[{"start":{"row":51,"column":0},"end":{"row":52,"column":0},"action":"insert","lines":["",""],"id":16},{"start":{"row":52,"column":0},"end":{"row":53,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":53,"column":0},"end":{"row":55,"column":33},"action":"insert","lines":["        # Query DynamoDB table for all items","        response = rcf_score_table.scan()","        items = response['Items']"],"id":17}],[{"start":{"row":55,"column":33},"end":{"row":56,"column":0},"action":"insert","lines":["",""],"id":18},{"start":{"row":56,"column":0},"end":{"row":56,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":53,"column":0},"end":{"row":53,"column":4},"action":"remove","lines":["    "],"id":19},{"start":{"row":54,"column":0},"end":{"row":54,"column":4},"action":"remove","lines":["    "]},{"start":{"row":55,"column":0},"end":{"row":55,"column":4},"action":"remove","lines":["    "]}],[{"start":{"row":43,"column":4},"end":{"row":43,"column":6},"action":"insert","lines":["# "],"id":20},{"start":{"row":44,"column":4},"end":{"row":44,"column":6},"action":"insert","lines":["# "]},{"start":{"row":46,"column":4},"end":{"row":46,"column":6},"action":"insert","lines":["# "]},{"start":{"row":47,"column":4},"end":{"row":47,"column":6},"action":"insert","lines":["# "]},{"start":{"row":49,"column":4},"end":{"row":49,"column":6},"action":"insert","lines":["# "]},{"start":{"row":50,"column":4},"end":{"row":50,"column":6},"action":"insert","lines":["# "]}],[{"start":{"row":13,"column":0},"end":{"row":15,"column":0},"action":"remove","lines":["rcf_score_table = os.environ['SCORE_DATA'] #  dynamodb.Table('CsvData')  # Replace 'CsvData' with your DynamoDB table name","",""],"id":21}],[{"start":{"row":15,"column":8},"end":{"row":16,"column":0},"action":"remove","lines":["",""],"id":22},{"start":{"row":15,"column":4},"end":{"row":15,"column":8},"action":"remove","lines":["    "]},{"start":{"row":15,"column":0},"end":{"row":15,"column":4},"action":"remove","lines":["    "]},{"start":{"row":14,"column":0},"end":{"row":15,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":13,"column":0},"end":{"row":14,"column":0},"action":"remove","lines":["",""],"id":23}],[{"start":{"row":38,"column":4},"end":{"row":38,"column":6},"action":"remove","lines":["# "],"id":25},{"start":{"row":39,"column":4},"end":{"row":39,"column":6},"action":"remove","lines":["# "]},{"start":{"row":41,"column":4},"end":{"row":41,"column":6},"action":"remove","lines":["# "]},{"start":{"row":42,"column":4},"end":{"row":42,"column":6},"action":"remove","lines":["# "]},{"start":{"row":44,"column":4},"end":{"row":44,"column":6},"action":"remove","lines":["# "]},{"start":{"row":45,"column":4},"end":{"row":45,"column":6},"action":"remove","lines":["# "]}],[{"start":{"row":38,"column":3},"end":{"row":51,"column":8},"action":"remove","lines":[" bucket_name = os.environ['SCORE_DATA'] # 'aws-toys-rong'","    file_key = 'anomaly_scores.csv'","","    response = s3.get_object(Bucket=bucket_name, Key=file_key)","    csv_content = response['Body'].read().decode('utf-8')","","    # Parse CSV content","    csv_rows = csv.DictReader(io.StringIO(csv_content))","","","    # Query DynamoDB table for all items","    response = rcf_score_table.scan()","    items = response['Items']","        "],"id":26},{"start":{"row":38,"column":3},"end":{"row":53,"column":26},"action":"insert","lines":["for record in event['Records']:","        bucket_name = record['s3']['bucket']['name']","        object_key = record['s3']['object']['key']","        event_name = record['eventName']","        ","        # bucket_name = 'rong-test-0512'","        # file_key = 'energy.csv'","    ","        # 讀取 CSV 檔案","        response = s3.get_object(Bucket=bucket_name, Key=object_key)","        csv_content = response['Body'].read().decode('utf-8')","        ","        # 將 CSV 轉換為 JSON 格式","        csv_rows = csv.DictReader(io.StringIO(csv_content))","        json_output = json.dumps([row for row in csv_rows])","        print(json_output)"]}],[{"start":{"row":53,"column":26},"end":{"row":54,"column":0},"action":"insert","lines":["",""],"id":27},{"start":{"row":54,"column":0},"end":{"row":54,"column":8},"action":"insert","lines":["        "]},{"start":{"row":54,"column":8},"end":{"row":55,"column":0},"action":"insert","lines":["",""]},{"start":{"row":55,"column":0},"end":{"row":55,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":55,"column":8},"end":{"row":89,"column":9},"action":"insert","lines":["        # 根據 CSV 檔案的內容動態生成提示訊息","    ","        prompt = f'explain the text {json_output}'","        # prompt = f'explain the text {json_output2}'","            ","        # 建立 Bedrock 客戶端","        bedrock = boto3.client(","            service_name='bedrock-runtime'#,","            # region_name='us-west-2'","        )  ","    ","        ","        # 設置 Bedrock 模型的輸入參數","        input_data = {","            \"modelId\": bedrock_model_id,  # \"cohere.command-text-v14\",","            \"contentType\": \"application/json\",","            \"accept\": \"*/*\",","            \"body\": {","                \"prompt\": prompt,","                \"max_tokens\": 1000,","                \"temperature\": 0.75,","                \"p\": 0.01,","                \"k\": 0,","                \"stop_sequences\": [],","                \"return_likelihoods\": \"NONE\"","            }","        }","        ","        # 呼叫 Bedrock 模型","        response = bedrock.invoke_model(","            body=json.dumps(input_data[\"body\"]),","            modelId=input_data[\"modelId\"],","            accept=input_data[\"accept\"],","            contentType=input_data[\"contentType\"]","        )"],"id":28}],[{"start":{"row":57,"column":0},"end":{"row":59,"column":0},"action":"remove","lines":["        prompt = f'explain the text {json_output}'","        # prompt = f'explain the text {json_output2}'",""],"id":29},{"start":{"row":57,"column":0},"end":{"row":68,"column":0},"action":"insert","lines":["            prompt = f\"As an energy management expert with over 30 years of experience, we're reaching out to you for assistance in analyzing anomalous data related to building energy consumption. Your insights are invaluable in resolving this issue.\\n\\n\" \\","         f\"Item: {Target}\\n\" \\","         f\"Date: {date}\\n\" \\","         f\"Energy Consumption Value: {value} kWh\\n\" \\","         f\"Anomaly Score: {score}\\n\\n\" \\","                 f\"Please provide the following:\\n\\n\" \\","         f\"1. Brief summary of the anomaly, including how the energy consumption value deviates from normal patterns.\\n\\n\" \\","         f\"2. Analysis of possible causes for the anomaly.\\n\" \\","         f\"3. Steps for further investigation.\\n\" \\","         f\"4. Recommended methods to address and resolve the issue.\\n\\n\" \\","         f\"Your suggestions should be detailed and specific to effectively address the anomaly.\"",""]}],[{"start":{"row":57,"column":0},"end":{"row":57,"column":4},"action":"remove","lines":["    "],"id":30}],[{"start":{"row":55,"column":0},"end":{"row":67,"column":96},"action":"remove","lines":["                # 根據 CSV 檔案的內容動態生成提示訊息","    ","        prompt = f\"As an energy management expert with over 30 years of experience, we're reaching out to you for assistance in analyzing anomalous data related to building energy consumption. Your insights are invaluable in resolving this issue.\\n\\n\" \\","         f\"Item: {Target}\\n\" \\","         f\"Date: {date}\\n\" \\","         f\"Energy Consumption Value: {value} kWh\\n\" \\","         f\"Anomaly Score: {score}\\n\\n\" \\","                 f\"Please provide the following:\\n\\n\" \\","         f\"1. Brief summary of the anomaly, including how the energy consumption value deviates from normal patterns.\\n\\n\" \\","         f\"2. Analysis of possible causes for the anomaly.\\n\" \\","         f\"3. Steps for further investigation.\\n\" \\","         f\"4. Recommended methods to address and resolve the issue.\\n\\n\" \\","         f\"Your suggestions should be detailed and specific to effectively address the anomaly.\""],"id":31},{"start":{"row":55,"column":0},"end":{"row":72,"column":0},"action":"insert","lines":["    for row in csv_rows:","        score = float(row['anomaly_score'])","        if score > 1:","            date = row['Date']","            Target = row['Target']","            value = row['Value (kWh)']","            prompt = f\"As an energy management expert with over 30 years of experience, we're reaching out to you for assistance in analyzing anomalous data related to building energy consumption. Your insights are invaluable in resolving this issue.\\n\\n\" \\","         f\"Item: {Target}\\n\" \\","         f\"Date: {date}\\n\" \\","         f\"Energy Consumption Value: {value} kWh\\n\" \\","         f\"Anomaly Score: {score}\\n\\n\" \\","                 f\"Please provide the following:\\n\\n\" \\","         f\"1. Brief summary of the anomaly, including how the energy consumption value deviates from normal patterns.\\n\\n\" \\","         f\"2. Analysis of possible causes for the anomaly.\\n\" \\","         f\"3. Steps for further investigation.\\n\" \\","         f\"4. Recommended methods to address and resolve the issue.\\n\\n\" \\","         f\"Your suggestions should be detailed and specific to effectively address the anomaly.\"",""]}],[{"start":{"row":52,"column":8},"end":{"row":52,"column":10},"action":"insert","lines":["# "],"id":32}],[{"start":{"row":53,"column":8},"end":{"row":53,"column":10},"action":"insert","lines":["# "],"id":33}],[{"start":{"row":55,"column":0},"end":{"row":55,"column":4},"action":"insert","lines":["    "],"id":34},{"start":{"row":56,"column":0},"end":{"row":56,"column":4},"action":"insert","lines":["    "]},{"start":{"row":57,"column":0},"end":{"row":57,"column":4},"action":"insert","lines":["    "]},{"start":{"row":58,"column":0},"end":{"row":58,"column":4},"action":"insert","lines":["    "]},{"start":{"row":59,"column":0},"end":{"row":59,"column":4},"action":"insert","lines":["    "]},{"start":{"row":60,"column":0},"end":{"row":60,"column":4},"action":"insert","lines":["    "]},{"start":{"row":61,"column":0},"end":{"row":61,"column":4},"action":"insert","lines":["    "]},{"start":{"row":62,"column":0},"end":{"row":62,"column":4},"action":"insert","lines":["    "]},{"start":{"row":63,"column":0},"end":{"row":63,"column":4},"action":"insert","lines":["    "]},{"start":{"row":64,"column":0},"end":{"row":64,"column":4},"action":"insert","lines":["    "]},{"start":{"row":65,"column":0},"end":{"row":65,"column":4},"action":"insert","lines":["    "]},{"start":{"row":66,"column":0},"end":{"row":66,"column":4},"action":"insert","lines":["    "]},{"start":{"row":67,"column":0},"end":{"row":67,"column":4},"action":"insert","lines":["    "]},{"start":{"row":68,"column":0},"end":{"row":68,"column":4},"action":"insert","lines":["    "]},{"start":{"row":69,"column":0},"end":{"row":69,"column":4},"action":"insert","lines":["    "]},{"start":{"row":70,"column":0},"end":{"row":70,"column":4},"action":"insert","lines":["    "]},{"start":{"row":71,"column":0},"end":{"row":71,"column":4},"action":"insert","lines":["    "]},{"start":{"row":72,"column":0},"end":{"row":72,"column":4},"action":"insert","lines":["    "]},{"start":{"row":73,"column":0},"end":{"row":73,"column":4},"action":"insert","lines":["    "]},{"start":{"row":74,"column":0},"end":{"row":74,"column":4},"action":"insert","lines":["    "]},{"start":{"row":75,"column":0},"end":{"row":75,"column":4},"action":"insert","lines":["    "]},{"start":{"row":76,"column":0},"end":{"row":76,"column":4},"action":"insert","lines":["    "]},{"start":{"row":77,"column":0},"end":{"row":77,"column":4},"action":"insert","lines":["    "]},{"start":{"row":78,"column":0},"end":{"row":78,"column":4},"action":"insert","lines":["    "]},{"start":{"row":79,"column":0},"end":{"row":79,"column":4},"action":"insert","lines":["    "]},{"start":{"row":80,"column":0},"end":{"row":80,"column":4},"action":"insert","lines":["    "]},{"start":{"row":81,"column":0},"end":{"row":81,"column":4},"action":"insert","lines":["    "]},{"start":{"row":82,"column":0},"end":{"row":82,"column":4},"action":"insert","lines":["    "]},{"start":{"row":83,"column":0},"end":{"row":83,"column":4},"action":"insert","lines":["    "]},{"start":{"row":84,"column":0},"end":{"row":84,"column":4},"action":"insert","lines":["    "]},{"start":{"row":85,"column":0},"end":{"row":85,"column":4},"action":"insert","lines":["    "]},{"start":{"row":86,"column":0},"end":{"row":86,"column":4},"action":"insert","lines":["    "]},{"start":{"row":87,"column":0},"end":{"row":87,"column":4},"action":"insert","lines":["    "]},{"start":{"row":88,"column":0},"end":{"row":88,"column":4},"action":"insert","lines":["    "]},{"start":{"row":89,"column":0},"end":{"row":89,"column":4},"action":"insert","lines":["    "]},{"start":{"row":90,"column":0},"end":{"row":90,"column":4},"action":"insert","lines":["    "]},{"start":{"row":91,"column":0},"end":{"row":91,"column":4},"action":"insert","lines":["    "]},{"start":{"row":92,"column":0},"end":{"row":92,"column":4},"action":"insert","lines":["    "]},{"start":{"row":93,"column":0},"end":{"row":93,"column":4},"action":"insert","lines":["    "]},{"start":{"row":94,"column":0},"end":{"row":94,"column":4},"action":"insert","lines":["    "]},{"start":{"row":95,"column":0},"end":{"row":95,"column":4},"action":"insert","lines":["    "]},{"start":{"row":96,"column":0},"end":{"row":96,"column":4},"action":"insert","lines":["    "]},{"start":{"row":97,"column":0},"end":{"row":97,"column":4},"action":"insert","lines":["    "]},{"start":{"row":98,"column":0},"end":{"row":98,"column":4},"action":"insert","lines":["    "]},{"start":{"row":99,"column":0},"end":{"row":99,"column":4},"action":"insert","lines":["    "]},{"start":{"row":100,"column":0},"end":{"row":100,"column":4},"action":"insert","lines":["    "]},{"start":{"row":101,"column":0},"end":{"row":101,"column":4},"action":"insert","lines":["    "]},{"start":{"row":102,"column":0},"end":{"row":102,"column":4},"action":"insert","lines":["    "]},{"start":{"row":103,"column":0},"end":{"row":103,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":104,"column":0},"end":{"row":126,"column":0},"action":"remove","lines":["    # Initialize Bedrock client","    bedrock = boto3.client(service_name='bedrock-runtime', region_name='us-west-2')","","    for row in csv_rows:","        score = float(row['anomaly_score'])","        if score > 1:","            date = row['Date']","            Target = row['Target']","            value = row['Value (kWh)']","            prompt = f\"As an energy management expert with over 30 years of experience, we're reaching out to you for assistance in analyzing anomalous data related to building energy consumption. Your insights are invaluable in resolving this issue.\\n\\n\" \\","         f\"Item: {Target}\\n\" \\","         f\"Date: {date}\\n\" \\","         f\"Energy Consumption Value: {value} kWh\\n\" \\","         f\"Anomaly Score: {score}\\n\\n\" \\","                 f\"Please provide the following:\\n\\n\" \\","         f\"1. Brief summary of the anomaly, including how the energy consumption value deviates from normal patterns.\\n\\n\" \\","         f\"2. Analysis of possible causes for the anomaly.\\n\" \\","         f\"3. Steps for further investigation.\\n\" \\","         f\"4. Recommended methods to address and resolve the issue.\\n\\n\" \\","         f\"Your suggestions should be detailed and specific to effectively address the anomaly.\"","         ","        # Set Bedrock model input parameters",""],"id":35}],[{"start":{"row":104,"column":7},"end":{"row":116,"column":13},"action":"remove","lines":[" input_data = {","            \"modelId\": \"cohere.command-text-v14\",","            \"contentType\": \"application/json\",","            \"accept\": \"*/*\",","            \"body\": {","                \"prompt\": prompt,","                \"max_tokens\": 1000,","                \"temperature\": 0.75,","                \"p\": 0.01,","                \"k\": 0,","                \"stop_sequences\": [],","                \"return_likelihoods\": \"NONE\"","            }"],"id":36},{"start":{"row":104,"column":6},"end":{"row":104,"column":7},"action":"remove","lines":[" "]},{"start":{"row":104,"column":5},"end":{"row":104,"column":6},"action":"remove","lines":[" "]},{"start":{"row":104,"column":4},"end":{"row":104,"column":5},"action":"remove","lines":[" "]},{"start":{"row":104,"column":0},"end":{"row":104,"column":4},"action":"remove","lines":["    "]},{"start":{"row":103,"column":13},"end":{"row":104,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":104,"column":8},"end":{"row":104,"column":9},"action":"remove","lines":["}"],"id":37}],[{"start":{"row":106,"column":1},"end":{"row":111,"column":9},"action":"remove","lines":["       response = bedrock.invoke_model(","            body=json.dumps(input_data[\"body\"]),","            modelId=input_data[\"modelId\"],","            accept=input_data[\"accept\"],","            contentType=input_data[\"contentType\"]","        )"],"id":38}],[{"start":{"row":105,"column":8},"end":{"row":105,"column":28},"action":"remove","lines":["# Call Bedrock model"],"id":39}],[{"start":{"row":97,"column":12},"end":{"row":97,"column":27},"action":"remove","lines":["# 呼叫 Bedrock 模型"],"id":40},{"start":{"row":97,"column":12},"end":{"row":97,"column":32},"action":"insert","lines":["# Call Bedrock model"]}],[{"start":{"row":108,"column":0},"end":{"row":108,"column":4},"action":"insert","lines":["    "],"id":41},{"start":{"row":109,"column":0},"end":{"row":109,"column":4},"action":"insert","lines":["    "]},{"start":{"row":110,"column":0},"end":{"row":110,"column":4},"action":"insert","lines":["    "]},{"start":{"row":111,"column":0},"end":{"row":111,"column":4},"action":"insert","lines":["    "]},{"start":{"row":112,"column":0},"end":{"row":112,"column":4},"action":"insert","lines":["    "]},{"start":{"row":113,"column":0},"end":{"row":113,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":106,"column":0},"end":{"row":106,"column":1},"action":"remove","lines":[" "],"id":42},{"start":{"row":105,"column":8},"end":{"row":106,"column":0},"action":"remove","lines":["",""]},{"start":{"row":105,"column":4},"end":{"row":105,"column":8},"action":"remove","lines":["    "]},{"start":{"row":105,"column":0},"end":{"row":105,"column":4},"action":"remove","lines":["    "]},{"start":{"row":104,"column":8},"end":{"row":105,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":105,"column":0},"end":{"row":105,"column":4},"action":"remove","lines":["    "],"id":43},{"start":{"row":104,"column":8},"end":{"row":105,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":119,"column":4},"end":{"row":119,"column":6},"action":"remove","lines":["# "],"id":44},{"start":{"row":120,"column":4},"end":{"row":120,"column":6},"action":"remove","lines":["# "]},{"start":{"row":121,"column":4},"end":{"row":121,"column":6},"action":"remove","lines":["# "]},{"start":{"row":122,"column":4},"end":{"row":122,"column":6},"action":"remove","lines":["# "]},{"start":{"row":124,"column":4},"end":{"row":124,"column":6},"action":"remove","lines":["# "]},{"start":{"row":125,"column":4},"end":{"row":125,"column":6},"action":"remove","lines":["# "]},{"start":{"row":127,"column":4},"end":{"row":127,"column":6},"action":"remove","lines":["# "]},{"start":{"row":128,"column":4},"end":{"row":128,"column":6},"action":"remove","lines":["# "]},{"start":{"row":129,"column":4},"end":{"row":129,"column":6},"action":"remove","lines":["# "]},{"start":{"row":131,"column":4},"end":{"row":131,"column":6},"action":"remove","lines":["# "]},{"start":{"row":132,"column":4},"end":{"row":132,"column":6},"action":"remove","lines":["# "]},{"start":{"row":133,"column":4},"end":{"row":133,"column":6},"action":"remove","lines":["# "]},{"start":{"row":134,"column":4},"end":{"row":134,"column":6},"action":"remove","lines":["# "]},{"start":{"row":138,"column":4},"end":{"row":138,"column":6},"action":"remove","lines":["# "]},{"start":{"row":139,"column":4},"end":{"row":139,"column":6},"action":"remove","lines":["# "]},{"start":{"row":140,"column":4},"end":{"row":140,"column":6},"action":"remove","lines":["# "]},{"start":{"row":142,"column":4},"end":{"row":142,"column":6},"action":"remove","lines":["# "]},{"start":{"row":143,"column":4},"end":{"row":143,"column":6},"action":"remove","lines":["# "]},{"start":{"row":144,"column":4},"end":{"row":144,"column":6},"action":"remove","lines":["# "]},{"start":{"row":145,"column":4},"end":{"row":145,"column":6},"action":"remove","lines":["# "]},{"start":{"row":146,"column":4},"end":{"row":146,"column":6},"action":"remove","lines":["# "]},{"start":{"row":149,"column":4},"end":{"row":149,"column":6},"action":"remove","lines":["# "]},{"start":{"row":150,"column":4},"end":{"row":150,"column":6},"action":"remove","lines":["# "]},{"start":{"row":151,"column":4},"end":{"row":151,"column":6},"action":"remove","lines":["# "]},{"start":{"row":152,"column":4},"end":{"row":152,"column":6},"action":"remove","lines":["# "]},{"start":{"row":153,"column":4},"end":{"row":153,"column":6},"action":"remove","lines":["# "]},{"start":{"row":154,"column":4},"end":{"row":154,"column":6},"action":"remove","lines":["# "]},{"start":{"row":155,"column":4},"end":{"row":155,"column":6},"action":"remove","lines":["# "]},{"start":{"row":156,"column":4},"end":{"row":156,"column":6},"action":"remove","lines":["# "]},{"start":{"row":157,"column":4},"end":{"row":157,"column":6},"action":"remove","lines":["# "]},{"start":{"row":158,"column":4},"end":{"row":158,"column":6},"action":"remove","lines":["# "]},{"start":{"row":159,"column":4},"end":{"row":159,"column":6},"action":"remove","lines":["# "]},{"start":{"row":160,"column":4},"end":{"row":160,"column":6},"action":"remove","lines":["# "]},{"start":{"row":161,"column":4},"end":{"row":161,"column":6},"action":"remove","lines":["# "]},{"start":{"row":162,"column":4},"end":{"row":162,"column":6},"action":"remove","lines":["# "]},{"start":{"row":163,"column":4},"end":{"row":163,"column":6},"action":"remove","lines":["# "]},{"start":{"row":165,"column":4},"end":{"row":165,"column":6},"action":"remove","lines":["# "]},{"start":{"row":166,"column":4},"end":{"row":166,"column":6},"action":"remove","lines":["# "]},{"start":{"row":167,"column":4},"end":{"row":167,"column":6},"action":"remove","lines":["# "]},{"start":{"row":168,"column":4},"end":{"row":168,"column":6},"action":"remove","lines":["# "]},{"start":{"row":169,"column":4},"end":{"row":169,"column":6},"action":"remove","lines":["# "]},{"start":{"row":170,"column":4},"end":{"row":170,"column":6},"action":"remove","lines":["# "]},{"start":{"row":171,"column":4},"end":{"row":171,"column":6},"action":"remove","lines":["# "]},{"start":{"row":173,"column":4},"end":{"row":173,"column":6},"action":"remove","lines":["# "]},{"start":{"row":174,"column":4},"end":{"row":174,"column":6},"action":"remove","lines":["# "]},{"start":{"row":175,"column":4},"end":{"row":175,"column":6},"action":"remove","lines":["# "]},{"start":{"row":176,"column":4},"end":{"row":176,"column":6},"action":"remove","lines":["# "]}],[{"start":{"row":178,"column":0},"end":{"row":178,"column":4},"action":"insert","lines":["    "],"id":45},{"start":{"row":179,"column":0},"end":{"row":179,"column":4},"action":"insert","lines":["    "]},{"start":{"row":180,"column":0},"end":{"row":180,"column":4},"action":"insert","lines":["    "]},{"start":{"row":181,"column":0},"end":{"row":181,"column":4},"action":"insert","lines":["    "]},{"start":{"row":182,"column":0},"end":{"row":182,"column":4},"action":"insert","lines":["    "]},{"start":{"row":183,"column":0},"end":{"row":183,"column":4},"action":"insert","lines":["    "]},{"start":{"row":184,"column":0},"end":{"row":184,"column":4},"action":"insert","lines":["    "]},{"start":{"row":185,"column":0},"end":{"row":185,"column":4},"action":"insert","lines":["    "]},{"start":{"row":186,"column":0},"end":{"row":186,"column":4},"action":"insert","lines":["    "]},{"start":{"row":187,"column":0},"end":{"row":187,"column":4},"action":"insert","lines":["    "]},{"start":{"row":188,"column":0},"end":{"row":188,"column":4},"action":"insert","lines":["    "]},{"start":{"row":189,"column":0},"end":{"row":189,"column":4},"action":"insert","lines":["    "]},{"start":{"row":190,"column":0},"end":{"row":190,"column":4},"action":"insert","lines":["    "]},{"start":{"row":191,"column":0},"end":{"row":191,"column":4},"action":"insert","lines":["    "]},{"start":{"row":192,"column":0},"end":{"row":192,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":134,"column":8},"end":{"row":134,"column":10},"action":"insert","lines":["# "],"id":46}],[{"start":{"row":133,"column":8},"end":{"row":133,"column":10},"action":"insert","lines":["# "],"id":47}],[{"start":{"row":138,"column":8},"end":{"row":138,"column":10},"action":"insert","lines":["# "],"id":48},{"start":{"row":139,"column":8},"end":{"row":139,"column":10},"action":"insert","lines":["# "]},{"start":{"row":140,"column":8},"end":{"row":140,"column":10},"action":"insert","lines":["# "]}],[{"start":{"row":137,"column":0},"end":{"row":154,"column":0},"action":"insert","lines":["        for row in csv_rows:","            score = float(row['anomaly_score'])","            if score > 1:","                date = row['Date']","                Target = row['Target']","                value = row['Value (kWh)']","                prompt = f\"As an energy management expert with over 30 years of experience, we're reaching out to you for assistance in analyzing anomalous data related to building energy consumption. Your insights are invaluable in resolving this issue.\\n\\n\" \\","             f\"Item: {Target}\\n\" \\","             f\"Date: {date}\\n\" \\","             f\"Energy Consumption Value: {value} kWh\\n\" \\","             f\"Anomaly Score: {score}\\n\\n\" \\","                     f\"Please provide the following:\\n\\n\" \\","             f\"1. Brief summary of the anomaly, including how the energy consumption value deviates from normal patterns.\\n\\n\" \\","             f\"2. Analysis of possible causes for the anomaly.\\n\" \\","             f\"3. Steps for further investigation.\\n\" \\","             f\"4. Recommended methods to address and resolve the issue.\\n\\n\" \\","             f\"Your suggestions should be detailed and specific to effectively address the anomaly.\"",""],"id":49}],[{"start":{"row":155,"column":0},"end":{"row":155,"column":4},"action":"insert","lines":["    "],"id":50},{"start":{"row":156,"column":0},"end":{"row":156,"column":4},"action":"insert","lines":["    "]},{"start":{"row":157,"column":0},"end":{"row":157,"column":4},"action":"insert","lines":["    "]},{"start":{"row":158,"column":0},"end":{"row":158,"column":4},"action":"insert","lines":["    "]},{"start":{"row":159,"column":0},"end":{"row":159,"column":4},"action":"insert","lines":["    "]},{"start":{"row":160,"column":0},"end":{"row":160,"column":4},"action":"insert","lines":["    "]},{"start":{"row":161,"column":0},"end":{"row":161,"column":4},"action":"insert","lines":["    "]},{"start":{"row":162,"column":0},"end":{"row":162,"column":4},"action":"insert","lines":["    "]},{"start":{"row":163,"column":0},"end":{"row":163,"column":4},"action":"insert","lines":["    "]},{"start":{"row":164,"column":0},"end":{"row":164,"column":4},"action":"insert","lines":["    "]},{"start":{"row":165,"column":0},"end":{"row":165,"column":4},"action":"insert","lines":["    "]},{"start":{"row":166,"column":0},"end":{"row":166,"column":4},"action":"insert","lines":["    "]},{"start":{"row":167,"column":0},"end":{"row":167,"column":4},"action":"insert","lines":["    "]},{"start":{"row":168,"column":0},"end":{"row":168,"column":4},"action":"insert","lines":["    "]},{"start":{"row":169,"column":0},"end":{"row":169,"column":4},"action":"insert","lines":["    "]},{"start":{"row":170,"column":0},"end":{"row":170,"column":4},"action":"insert","lines":["    "]},{"start":{"row":171,"column":0},"end":{"row":171,"column":4},"action":"insert","lines":["    "]},{"start":{"row":172,"column":0},"end":{"row":172,"column":4},"action":"insert","lines":["    "]},{"start":{"row":173,"column":0},"end":{"row":173,"column":4},"action":"insert","lines":["    "]},{"start":{"row":174,"column":0},"end":{"row":174,"column":4},"action":"insert","lines":["    "]},{"start":{"row":175,"column":0},"end":{"row":175,"column":4},"action":"insert","lines":["    "]},{"start":{"row":176,"column":0},"end":{"row":176,"column":4},"action":"insert","lines":["    "]},{"start":{"row":177,"column":0},"end":{"row":177,"column":4},"action":"insert","lines":["    "]},{"start":{"row":178,"column":0},"end":{"row":178,"column":4},"action":"insert","lines":["    "]},{"start":{"row":179,"column":0},"end":{"row":179,"column":4},"action":"insert","lines":["    "]},{"start":{"row":180,"column":0},"end":{"row":180,"column":4},"action":"insert","lines":["    "]},{"start":{"row":181,"column":0},"end":{"row":181,"column":4},"action":"insert","lines":["    "]},{"start":{"row":182,"column":0},"end":{"row":182,"column":4},"action":"insert","lines":["    "]},{"start":{"row":183,"column":0},"end":{"row":183,"column":4},"action":"insert","lines":["    "]},{"start":{"row":184,"column":0},"end":{"row":184,"column":4},"action":"insert","lines":["    "]},{"start":{"row":185,"column":0},"end":{"row":185,"column":4},"action":"insert","lines":["    "]},{"start":{"row":186,"column":0},"end":{"row":186,"column":4},"action":"insert","lines":["    "]},{"start":{"row":187,"column":0},"end":{"row":187,"column":4},"action":"insert","lines":["    "]},{"start":{"row":188,"column":0},"end":{"row":188,"column":4},"action":"insert","lines":["    "]},{"start":{"row":189,"column":0},"end":{"row":189,"column":4},"action":"insert","lines":["    "]},{"start":{"row":190,"column":0},"end":{"row":190,"column":4},"action":"insert","lines":["    "]},{"start":{"row":191,"column":0},"end":{"row":191,"column":4},"action":"insert","lines":["    "]},{"start":{"row":192,"column":0},"end":{"row":192,"column":4},"action":"insert","lines":["    "]},{"start":{"row":193,"column":0},"end":{"row":193,"column":4},"action":"insert","lines":["    "]},{"start":{"row":194,"column":0},"end":{"row":194,"column":4},"action":"insert","lines":["    "]},{"start":{"row":195,"column":0},"end":{"row":195,"column":4},"action":"insert","lines":["    "]},{"start":{"row":196,"column":0},"end":{"row":196,"column":4},"action":"insert","lines":["    "]},{"start":{"row":197,"column":0},"end":{"row":197,"column":4},"action":"insert","lines":["    "]},{"start":{"row":198,"column":0},"end":{"row":198,"column":4},"action":"insert","lines":["    "]},{"start":{"row":199,"column":0},"end":{"row":199,"column":4},"action":"insert","lines":["    "]},{"start":{"row":200,"column":0},"end":{"row":200,"column":4},"action":"insert","lines":["    "]},{"start":{"row":201,"column":0},"end":{"row":201,"column":4},"action":"insert","lines":["    "]},{"start":{"row":202,"column":0},"end":{"row":202,"column":4},"action":"insert","lines":["    "]},{"start":{"row":203,"column":0},"end":{"row":203,"column":4},"action":"insert","lines":["    "]},{"start":{"row":204,"column":0},"end":{"row":204,"column":4},"action":"insert","lines":["    "]},{"start":{"row":205,"column":0},"end":{"row":205,"column":4},"action":"insert","lines":["    "]},{"start":{"row":206,"column":0},"end":{"row":206,"column":4},"action":"insert","lines":["    "]},{"start":{"row":207,"column":0},"end":{"row":207,"column":4},"action":"insert","lines":["    "]},{"start":{"row":208,"column":0},"end":{"row":208,"column":4},"action":"insert","lines":["    "]},{"start":{"row":209,"column":0},"end":{"row":209,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":37,"column":0},"end":{"row":37,"column":2},"action":"insert","lines":["# "],"id":51},{"start":{"row":38,"column":0},"end":{"row":38,"column":1},"action":"insert","lines":["#"]},{"start":{"row":39,"column":0},"end":{"row":39,"column":2},"action":"insert","lines":["# "]},{"start":{"row":40,"column":0},"end":{"row":40,"column":2},"action":"insert","lines":["# "]},{"start":{"row":41,"column":0},"end":{"row":41,"column":2},"action":"insert","lines":["# "]},{"start":{"row":43,"column":0},"end":{"row":43,"column":2},"action":"insert","lines":["# "]},{"start":{"row":44,"column":0},"end":{"row":44,"column":2},"action":"insert","lines":["# "]},{"start":{"row":46,"column":0},"end":{"row":46,"column":2},"action":"insert","lines":["# "]},{"start":{"row":47,"column":0},"end":{"row":47,"column":2},"action":"insert","lines":["# "]},{"start":{"row":48,"column":0},"end":{"row":48,"column":2},"action":"insert","lines":["# "]},{"start":{"row":50,"column":0},"end":{"row":50,"column":2},"action":"insert","lines":["# "]},{"start":{"row":51,"column":0},"end":{"row":51,"column":2},"action":"insert","lines":["# "]},{"start":{"row":52,"column":0},"end":{"row":52,"column":2},"action":"insert","lines":["# "]},{"start":{"row":53,"column":0},"end":{"row":53,"column":2},"action":"insert","lines":["# "]},{"start":{"row":55,"column":0},"end":{"row":55,"column":2},"action":"insert","lines":["# "]},{"start":{"row":56,"column":0},"end":{"row":56,"column":2},"action":"insert","lines":["# "]},{"start":{"row":57,"column":0},"end":{"row":57,"column":2},"action":"insert","lines":["# "]},{"start":{"row":58,"column":0},"end":{"row":58,"column":2},"action":"insert","lines":["# "]},{"start":{"row":59,"column":0},"end":{"row":59,"column":2},"action":"insert","lines":["# "]},{"start":{"row":60,"column":0},"end":{"row":60,"column":2},"action":"insert","lines":["# "]},{"start":{"row":61,"column":0},"end":{"row":61,"column":2},"action":"insert","lines":["# "]},{"start":{"row":62,"column":0},"end":{"row":62,"column":2},"action":"insert","lines":["# "]},{"start":{"row":63,"column":0},"end":{"row":63,"column":2},"action":"insert","lines":["# "]},{"start":{"row":64,"column":0},"end":{"row":64,"column":2},"action":"insert","lines":["# "]},{"start":{"row":65,"column":0},"end":{"row":65,"column":2},"action":"insert","lines":["# "]},{"start":{"row":66,"column":0},"end":{"row":66,"column":2},"action":"insert","lines":["# "]},{"start":{"row":67,"column":0},"end":{"row":67,"column":2},"action":"insert","lines":["# "]},{"start":{"row":68,"column":0},"end":{"row":68,"column":2},"action":"insert","lines":["# "]},{"start":{"row":69,"column":0},"end":{"row":69,"column":2},"action":"insert","lines":["# "]},{"start":{"row":70,"column":0},"end":{"row":70,"column":2},"action":"insert","lines":["# "]},{"start":{"row":71,"column":0},"end":{"row":71,"column":2},"action":"insert","lines":["# "]},{"start":{"row":74,"column":0},"end":{"row":74,"column":2},"action":"insert","lines":["# "]},{"start":{"row":75,"column":0},"end":{"row":75,"column":2},"action":"insert","lines":["# "]},{"start":{"row":76,"column":0},"end":{"row":76,"column":2},"action":"insert","lines":["# "]},{"start":{"row":77,"column":0},"end":{"row":77,"column":2},"action":"insert","lines":["# "]},{"start":{"row":78,"column":0},"end":{"row":78,"column":2},"action":"insert","lines":["# "]},{"start":{"row":81,"column":0},"end":{"row":81,"column":2},"action":"insert","lines":["# "]},{"start":{"row":82,"column":0},"end":{"row":82,"column":2},"action":"insert","lines":["# "]},{"start":{"row":83,"column":0},"end":{"row":83,"column":2},"action":"insert","lines":["# "]},{"start":{"row":84,"column":0},"end":{"row":84,"column":2},"action":"insert","lines":["# "]},{"start":{"row":85,"column":0},"end":{"row":85,"column":2},"action":"insert","lines":["# "]},{"start":{"row":86,"column":0},"end":{"row":86,"column":2},"action":"insert","lines":["# "]},{"start":{"row":87,"column":0},"end":{"row":87,"column":2},"action":"insert","lines":["# "]},{"start":{"row":88,"column":0},"end":{"row":88,"column":2},"action":"insert","lines":["# "]},{"start":{"row":89,"column":0},"end":{"row":89,"column":2},"action":"insert","lines":["# "]},{"start":{"row":90,"column":0},"end":{"row":90,"column":2},"action":"insert","lines":["# "]},{"start":{"row":91,"column":0},"end":{"row":91,"column":2},"action":"insert","lines":["# "]},{"start":{"row":92,"column":0},"end":{"row":92,"column":2},"action":"insert","lines":["# "]},{"start":{"row":93,"column":0},"end":{"row":93,"column":2},"action":"insert","lines":["# "]},{"start":{"row":94,"column":0},"end":{"row":94,"column":2},"action":"insert","lines":["# "]},{"start":{"row":95,"column":0},"end":{"row":95,"column":2},"action":"insert","lines":["# "]},{"start":{"row":97,"column":0},"end":{"row":97,"column":2},"action":"insert","lines":["# "]},{"start":{"row":98,"column":0},"end":{"row":98,"column":2},"action":"insert","lines":["# "]},{"start":{"row":99,"column":0},"end":{"row":99,"column":2},"action":"insert","lines":["# "]},{"start":{"row":100,"column":0},"end":{"row":100,"column":2},"action":"insert","lines":["# "]},{"start":{"row":101,"column":0},"end":{"row":101,"column":2},"action":"insert","lines":["# "]},{"start":{"row":102,"column":0},"end":{"row":102,"column":2},"action":"insert","lines":["# "]},{"start":{"row":103,"column":0},"end":{"row":103,"column":2},"action":"insert","lines":["# "]},{"start":{"row":105,"column":0},"end":{"row":105,"column":2},"action":"insert","lines":["# "]},{"start":{"row":106,"column":0},"end":{"row":106,"column":2},"action":"insert","lines":["# "]},{"start":{"row":107,"column":0},"end":{"row":107,"column":2},"action":"insert","lines":["# "]},{"start":{"row":108,"column":0},"end":{"row":108,"column":2},"action":"insert","lines":["# "]},{"start":{"row":110,"column":0},"end":{"row":110,"column":2},"action":"insert","lines":["# "]}],[{"start":{"row":115,"column":4},"end":{"row":115,"column":6},"action":"insert","lines":["# "],"id":52}],[{"start":{"row":144,"column":0},"end":{"row":144,"column":4},"action":"insert","lines":["    "],"id":53},{"start":{"row":145,"column":0},"end":{"row":145,"column":4},"action":"insert","lines":["    "]},{"start":{"row":146,"column":0},"end":{"row":146,"column":4},"action":"insert","lines":["    "]},{"start":{"row":147,"column":0},"end":{"row":147,"column":4},"action":"insert","lines":["    "]},{"start":{"row":148,"column":0},"end":{"row":148,"column":4},"action":"insert","lines":["    "]},{"start":{"row":149,"column":0},"end":{"row":149,"column":4},"action":"insert","lines":["    "]},{"start":{"row":150,"column":0},"end":{"row":150,"column":4},"action":"insert","lines":["    "]},{"start":{"row":151,"column":0},"end":{"row":151,"column":4},"action":"insert","lines":["    "]},{"start":{"row":152,"column":0},"end":{"row":152,"column":4},"action":"insert","lines":["    "]},{"start":{"row":153,"column":0},"end":{"row":153,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":159,"column":0},"end":{"row":159,"column":4},"action":"insert","lines":["    "],"id":54},{"start":{"row":160,"column":0},"end":{"row":160,"column":4},"action":"insert","lines":["    "]},{"start":{"row":161,"column":0},"end":{"row":161,"column":4},"action":"insert","lines":["    "]},{"start":{"row":162,"column":0},"end":{"row":162,"column":4},"action":"insert","lines":["    "]},{"start":{"row":163,"column":0},"end":{"row":163,"column":4},"action":"insert","lines":["    "]},{"start":{"row":164,"column":0},"end":{"row":164,"column":4},"action":"insert","lines":["    "]},{"start":{"row":165,"column":0},"end":{"row":165,"column":4},"action":"insert","lines":["    "]},{"start":{"row":166,"column":0},"end":{"row":166,"column":4},"action":"insert","lines":["    "]},{"start":{"row":167,"column":0},"end":{"row":167,"column":4},"action":"insert","lines":["    "]},{"start":{"row":168,"column":0},"end":{"row":168,"column":4},"action":"insert","lines":["    "]},{"start":{"row":169,"column":0},"end":{"row":169,"column":4},"action":"insert","lines":["    "]},{"start":{"row":170,"column":0},"end":{"row":170,"column":4},"action":"insert","lines":["    "]},{"start":{"row":171,"column":0},"end":{"row":171,"column":4},"action":"insert","lines":["    "]},{"start":{"row":172,"column":0},"end":{"row":172,"column":4},"action":"insert","lines":["    "]},{"start":{"row":173,"column":0},"end":{"row":173,"column":4},"action":"insert","lines":["    "]},{"start":{"row":174,"column":0},"end":{"row":174,"column":4},"action":"insert","lines":["    "]},{"start":{"row":175,"column":0},"end":{"row":175,"column":4},"action":"insert","lines":["    "]},{"start":{"row":176,"column":0},"end":{"row":176,"column":4},"action":"insert","lines":["    "]},{"start":{"row":177,"column":0},"end":{"row":177,"column":4},"action":"insert","lines":["    "]},{"start":{"row":178,"column":0},"end":{"row":178,"column":4},"action":"insert","lines":["    "]},{"start":{"row":179,"column":0},"end":{"row":179,"column":4},"action":"insert","lines":["    "]},{"start":{"row":180,"column":0},"end":{"row":180,"column":4},"action":"insert","lines":["    "]},{"start":{"row":181,"column":0},"end":{"row":181,"column":4},"action":"insert","lines":["    "]},{"start":{"row":182,"column":0},"end":{"row":182,"column":4},"action":"insert","lines":["    "]},{"start":{"row":183,"column":0},"end":{"row":183,"column":4},"action":"insert","lines":["    "]},{"start":{"row":184,"column":0},"end":{"row":184,"column":4},"action":"insert","lines":["    "]},{"start":{"row":185,"column":0},"end":{"row":185,"column":4},"action":"insert","lines":["    "]},{"start":{"row":186,"column":0},"end":{"row":186,"column":4},"action":"insert","lines":["    "]},{"start":{"row":187,"column":0},"end":{"row":187,"column":4},"action":"insert","lines":["    "]},{"start":{"row":188,"column":0},"end":{"row":188,"column":4},"action":"insert","lines":["    "]},{"start":{"row":189,"column":0},"end":{"row":189,"column":4},"action":"insert","lines":["    "]},{"start":{"row":190,"column":0},"end":{"row":190,"column":4},"action":"insert","lines":["    "]},{"start":{"row":191,"column":0},"end":{"row":191,"column":4},"action":"insert","lines":["    "]},{"start":{"row":192,"column":0},"end":{"row":192,"column":4},"action":"insert","lines":["    "]},{"start":{"row":193,"column":0},"end":{"row":193,"column":4},"action":"insert","lines":["    "]},{"start":{"row":194,"column":0},"end":{"row":194,"column":4},"action":"insert","lines":["    "]},{"start":{"row":195,"column":0},"end":{"row":195,"column":4},"action":"insert","lines":["    "]},{"start":{"row":196,"column":0},"end":{"row":196,"column":4},"action":"insert","lines":["    "]},{"start":{"row":197,"column":0},"end":{"row":197,"column":4},"action":"insert","lines":["    "]},{"start":{"row":198,"column":0},"end":{"row":198,"column":4},"action":"insert","lines":["    "]},{"start":{"row":199,"column":0},"end":{"row":199,"column":4},"action":"insert","lines":["    "]},{"start":{"row":200,"column":0},"end":{"row":200,"column":4},"action":"insert","lines":["    "]},{"start":{"row":201,"column":0},"end":{"row":201,"column":4},"action":"insert","lines":["    "]},{"start":{"row":202,"column":0},"end":{"row":202,"column":4},"action":"insert","lines":["    "]},{"start":{"row":203,"column":0},"end":{"row":203,"column":4},"action":"insert","lines":["    "]},{"start":{"row":204,"column":0},"end":{"row":204,"column":4},"action":"insert","lines":["    "]},{"start":{"row":205,"column":0},"end":{"row":205,"column":4},"action":"insert","lines":["    "]},{"start":{"row":206,"column":0},"end":{"row":206,"column":4},"action":"insert","lines":["    "]},{"start":{"row":207,"column":0},"end":{"row":207,"column":4},"action":"insert","lines":["    "]},{"start":{"row":208,"column":0},"end":{"row":208,"column":4},"action":"insert","lines":["    "]},{"start":{"row":209,"column":0},"end":{"row":209,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":37,"column":0},"end":{"row":110,"column":33},"action":"remove","lines":["# def detect_anomaly():","#   for record in event['Records']:","#         bucket_name = record['s3']['bucket']['name']","#         object_key = record['s3']['object']['key']","#         event_name = record['eventName']","        ","#         # bucket_name = 'rong-test-0512'","#         # file_key = 'energy.csv'","    ","#         # 讀取 CSV 檔案","#         response = s3.get_object(Bucket=bucket_name, Key=object_key)","#         csv_content = response['Body'].read().decode('utf-8')","        ","#         # 將 CSV 轉換為 JSON 格式","#         csv_rows = csv.DictReader(io.StringIO(csv_content))","#         # json_output = json.dumps([row for row in csv_rows])","#         # print(json_output)","        ","#         for row in csv_rows:","#             score = float(row['anomaly_score'])","#             if score > 1:","#                 date = row['Date']","#                 Target = row['Target']","#                 value = row['Value (kWh)']","#                 prompt = f\"As an energy management expert with over 30 years of experience, we're reaching out to you for assistance in analyzing anomalous data related to building energy consumption. Your insights are invaluable in resolving this issue.\\n\\n\" \\","#              f\"Item: {Target}\\n\" \\","#              f\"Date: {date}\\n\" \\","#              f\"Energy Consumption Value: {value} kWh\\n\" \\","#              f\"Anomaly Score: {score}\\n\\n\" \\","#                      f\"Please provide the following:\\n\\n\" \\","#              f\"1. Brief summary of the anomaly, including how the energy consumption value deviates from normal patterns.\\n\\n\" \\","#              f\"2. Analysis of possible causes for the anomaly.\\n\" \\","#              f\"3. Steps for further investigation.\\n\" \\","#              f\"4. Recommended methods to address and resolve the issue.\\n\\n\" \\","#              f\"Your suggestions should be detailed and specific to effectively address the anomaly.\"","    ","                ","#             # 建立 Bedrock 客戶端","#             bedrock = boto3.client(","#                 service_name='bedrock-runtime'#,","#                 # region_name='us-west-2'","#             )  ","        ","            ","#             # 設置 Bedrock 模型的輸入參數","#             input_data = {","#                 \"modelId\": bedrock_model_id,  # \"cohere.command-text-v14\",","#                 \"contentType\": \"application/json\",","#                 \"accept\": \"*/*\",","#                 \"body\": {","#                     \"prompt\": prompt,","#                     \"max_tokens\": 1000,","#                     \"temperature\": 0.75,","#                     \"p\": 0.01,","#                     \"k\": 0,","#                     \"stop_sequences\": [],","#                     \"return_likelihoods\": \"NONE\"","#                 }","#             }","            ","#             # Call Bedrock model","#             response = bedrock.invoke_model(","#                 body=json.dumps(input_data[\"body\"]),","#                 modelId=input_data[\"modelId\"],","#                 accept=input_data[\"accept\"],","#                 contentType=input_data[\"contentType\"]","#             )","        ","#             # Parse Bedrock response","#             response_body = json.loads(response['body'].read())","#             explanation = response_body['generations'][0]['text']    ","#             print(explanation)","            ","#             return explanation "],"id":55}],[{"start":{"row":10,"column":0},"end":{"row":10,"column":37},"action":"remove","lines":["# email = os.environ['EMAIL_ADDRESS']"],"id":56},{"start":{"row":9,"column":46},"end":{"row":10,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":28,"column":0},"end":{"row":28,"column":38},"action":"remove","lines":["        # 'RecordTime': datetime.now()"],"id":57},{"start":{"row":27,"column":27},"end":{"row":28,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":40,"column":0},"end":{"row":42,"column":20},"action":"remove","lines":["    # explanation = detect_anomaly()","","    # # 設定存儲桶名稱和檔案名稱"],"id":58},{"start":{"row":39,"column":4},"end":{"row":40,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":40,"column":7},"end":{"row":40,"column":8},"action":"remove","lines":[" "],"id":59},{"start":{"row":40,"column":6},"end":{"row":40,"column":7},"action":"remove","lines":["#"]}],[{"start":{"row":46,"column":0},"end":{"row":49,"column":19},"action":"remove","lines":["        # bucket_name = 'rong-test-0512'","        # file_key = 'energy.csv'","    ","        # 讀取 CSV 檔案"],"id":60},{"start":{"row":45,"column":8},"end":{"row":46,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":49,"column":0},"end":{"row":49,"column":27},"action":"remove","lines":["        # 將 CSV 轉換為 JSON 格式"],"id":61},{"start":{"row":48,"column":8},"end":{"row":49,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":50,"column":0},"end":{"row":51,"column":28},"action":"remove","lines":["        # json_output = json.dumps([row for row in csv_rows])","        # print(json_output)"],"id":62},{"start":{"row":49,"column":59},"end":{"row":50,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":50,"column":4},"end":{"row":51,"column":0},"action":"remove","lines":["",""],"id":63}],[{"start":{"row":69,"column":0},"end":{"row":73,"column":32},"action":"remove","lines":["            # # 根據 CSV 檔案的內容動態生成提示訊息","            # prompt = f'explain the text {json_output}'","            # # prompt = f'explain the text {json_output2}'","                ","                # 建立 Bedrock 客戶端"],"id":64},{"start":{"row":68,"column":0},"end":{"row":69,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":74,"column":6},"end":{"row":75,"column":36},"action":"remove","lines":["          ","                # 設置 Bedrock 模型的輸入參數"],"id":65},{"start":{"row":74,"column":5},"end":{"row":74,"column":6},"action":"remove","lines":[" "]},{"start":{"row":74,"column":4},"end":{"row":74,"column":5},"action":"remove","lines":[" "]},{"start":{"row":74,"column":0},"end":{"row":74,"column":4},"action":"remove","lines":["    "]},{"start":{"row":73,"column":12},"end":{"row":74,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":71,"column":20},"end":{"row":71,"column":45},"action":"remove","lines":["# region_name='us-west-2'"],"id":66}],[{"start":{"row":70,"column":51},"end":{"row":70,"column":52},"action":"remove","lines":[","],"id":68},{"start":{"row":70,"column":50},"end":{"row":70,"column":51},"action":"remove","lines":["#"]}],[{"start":{"row":71,"column":16},"end":{"row":71,"column":20},"action":"remove","lines":["    "],"id":69},{"start":{"row":71,"column":12},"end":{"row":71,"column":16},"action":"remove","lines":["    "]},{"start":{"row":71,"column":8},"end":{"row":71,"column":12},"action":"remove","lines":["    "]},{"start":{"row":71,"column":4},"end":{"row":71,"column":8},"action":"remove","lines":["    "]},{"start":{"row":71,"column":0},"end":{"row":71,"column":4},"action":"remove","lines":["    "]},{"start":{"row":70,"column":50},"end":{"row":71,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":88,"column":0},"end":{"row":88,"column":31},"action":"remove","lines":["                # 呼叫 Bedrock 模型"],"id":70},{"start":{"row":87,"column":16},"end":{"row":88,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":95,"column":2},"end":{"row":95,"column":33},"action":"remove","lines":["              # 讀取上面的s3內檔案並解析回應"],"id":71},{"start":{"row":95,"column":1},"end":{"row":95,"column":2},"action":"remove","lines":[" "]},{"start":{"row":95,"column":0},"end":{"row":95,"column":1},"action":"remove","lines":[" "]},{"start":{"row":94,"column":12},"end":{"row":95,"column":0},"action":"remove","lines":["",""]}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":8,"column":34},"end":{"row":8,"column":34},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":209,"mode":"ace/mode/python"}},"hash":"2be700b98d6eead5b654b194e12947ce46dfcb6e","timestamp":1716091477872}